---
title: "Ichthyoplankton_Thermal_Habitat"
author: "Sarah J. Weisberg"
date: "2025-01-01"
output: html_document
---
Code required to reproduce Weisberg et al. submission to Ecology Letters (2025)

Analyses use three datasets:
(1) Larval data from NOAA's EcoMon survey, available at gov.noaa.nodc:0187513
(2) Embryo DNA barcoding data from Lewis et al (2016), available on BOLD (portal.boldsystems.org) under project name NIFEB
(3) Embryo DNA barcoding data from Hadjiargyrou et al (in prep) available at dx.doi.org/10.5883/DS-NYOS with additional information at https://doi.org/10.6084/m9.figshare.27984443.v1

Auxiliary files needed for analyses are desbribed where relevant below.

#0 Prep
  Load packages
  Set plotting themes and color palette

```{r}
#load packages
#plotting
library(ggplot2) 
library(ggthemes) 
library(ggpubr)
library(gridExtra)
library(RColorBrewer)
library(patchwork)
library(paletteer)
library(rnaturalearth)
library(marmap)
library(scatterpie)

#data wrangling
library(dplyr) #tidy 
library(tidyverse) #tidy
library(zoo) #ordering
library(broom) #converts to tidy 
library(readxl) 
library(here)
library(rio)
library(sf)

#modeling
library(rstatix) #modeling with tidy
library(glmmTMB)#mixed models 

#set overall theme 
theme_Publication <- function(base_size=14, base_family="Arial") {
  
  (theme_foundation(base_size=base_size, base_family=base_family)
   + theme(plot.title = element_text(hjust = 0.5),
           text = element_text(),
           panel.background = element_rect(colour = NA),
           plot.background = element_rect(colour = NA),
           panel.border = element_rect(colour = NA),
           axis.title = element_text(size = rel(1)),
           axis.title.y = element_text(angle=90,vjust =2),
           axis.text = element_text(), 
           axis.line = element_line(colour="black"),
           axis.ticks = element_line(),
           panel.grid.major = element_line(colour="#f0f0f0"),
           panel.grid.minor = element_line(colour="#f0f0f0"),
           legend.key = element_rect(colour = NA),
           legend.position = "right",
           legend.spacing  = unit(0, "cm"),
           legend.title = element_text(face="italic"),
           strip.background=element_rect(colour="#f0f0f0",fill="#f0f0f0")
   ))
  
}

select <- dplyr::select
#choose color palette
my_pal <- paletteer_d("PrettyCols::Rainbow")
```
#1. Load and prep the three datasets

##1.1 Load and prep EcoMon larval data

Note that Butterfish (Peprilus sp.) are conservatively not identified to the species level in the public EcoMon dataset but species-level information was made available by David Richardson 
```{r}
#load in main EcoMon dataset
#accession date: May 6, 2024
ecomon <- read.csv(here("data/EcoMon_Data/EcoMon_Plankton_Data_v3_8.csv"))

#load in butterfish dataset from David Richardson
#has species-level classification of butterfish (genus-level reported in public EcoMon dataset)
butterfish_raw <- read_xlsx(here("data/DatasetExplanation_Peprilus_May2024.xlsx"))

#get rid of leading zeros in station column
butterfish <- butterfish_raw %>% mutate(station = round(as.numeric(STATION))) %>% 
  mutate(cruise_station = paste(CRUISE_NAME,station, sep = "_"))
#get rid of unneeded columns
butterfish <- butterfish %>% select(cruise_station,TAXA_ICHTHYO,ABUNDANCE)
#calculate abundance by butterfish species
#170511100 = Peprilus sp., 170511101 = P. paru, 170511103 = P. burti (presumed mis-ID), 170511104 = P. triacanthus
butterfish <- butterfish %>% group_by(cruise_station) %>% 
  mutate(pep_sp = sum(ABUNDANCE[which(TAXA_ICHTHYO == 170511100)])) %>%
  mutate(pep_par = sum(ABUNDANCE[which(TAXA_ICHTHYO == 170511101)])) %>%
  mutate(pep_tri = sum(ABUNDANCE[which(TAXA_ICHTHYO >= 170511102)])) %>%
  mutate(pep_tri = replace(pep_tri, is.na(pep_tri), 0)) %>%
  select(cruise_station,pep_par,pep_sp,pep_tri) %>%
  unique

butterfish <- butterfish %>% mutate(pep_all = pep_tri+pep_sp+pep_par)

#check proportion of abundance that is pep_tri = 99.9%
sum(butterfish$pep_tri)/(sum(butterfish$pep_tri)+sum(butterfish$pep_par))

#merge butterfish with rest
ecomon <- ecomon %>% mutate(cruise_station = paste(cruise_name,station, sep = "_"))

ecomon <- left_join(ecomon,butterfish,by="cruise_station")

## Prep dataset for single parameter quotient (SPQ) analysis

#convert code '9999' to NA
ecomon[ecomon == 9999] <- NA

#first split out x (environment) and y (species) to convert NAs to true 0s (because it is a survey)
#select only species of interest
ecomon_x <- ecomon %>% dplyr::select(cruise_station,sfc_temp)
ecomon_y <- ecomon %>% select("hipobl_10m2","merbil_10m2","citarc_10m2","scoaqu_10m2","pep_tri")
ecomon_y[is.na(ecomon_y)] <- 0 #NAs should be true 0s

ecomon <- cbind(ecomon_x, ecomon_y)
#eliminate instances lacking surface temp (SST) measurements
ecomon <- ecomon %>% filter(!is.na(sfc_temp))
ecomon_ynames <- colnames(ecomon_y)

#bin temperature by 0.5deg C
ecomon <- ecomon %>% mutate(temp_bin = round(sfc_temp*2)/2)
#generate distribution of sampled temperatures
temp_dist_ecomon <- ecomon %>% group_by(temp_bin) %>% tally %>% 
  mutate(total=sum(n),prop_samples=n/total) %>% dplyr::select(temp_bin,prop_samples,n)

#create long dataset of larval abundances for tidy manipulation 
#around temp to nearest 0.5deg bin
ecomon_long <- ecomon %>% pivot_longer(all_of(ecomon_ynames), names_to = "spp") %>% select(-temp_bin)

#remove excess dataframes 
rm(butterfish,butterfish_raw,ecomon_y,ecomon_x,ecomon_ynames)
```

##1.2 Load and prep embryo data from Lewis et al (2016)

Samples were collected in EcoMon cruises and a subset were identified to the species level using DNA barcoding
DNA barcoding results available on BOLD
Analyses here needed station information: CTD data for temperature, haul factor for abundance estimates. 
Lewis et al (2016) subsampled by diameter, we accounted for this as well here.

```{r}
#Load station data from subset of stations with ethanol-preserved samples
db_orig <- read_excel("data/FishEggDatabase_GenID.accdb.xls",sheet = "StationData")
#remove rows with NA egg count
#convert egg counts to numeric, create new column with cruise/station unique ID
db <- db_orig %>% filter(is.na(Egg_Count) == F) %>% 
  mutate(Egg_Count = as.numeric(Egg_Count),Station=as.double(Station),Ich_Haul_Fctr = as.numeric(Ich_Haul_Fctr)) %>%
  mutate(cruise_station = paste(Cruise_Name,Station,sep="_"))

#read in database with haul factor info
stations <- read.csv("data/DensitiesBySpecies.csv")
haul <- stations %>% rename(IHF = Ich_Haul_Fctr) %>% mutate(cruise_station = paste(Cruise_Name,Station,sep="_")) %>%
  dplyr::select(cruise_station,IHF)

#merge back with egg db, remove rows with haul factor = NA
#these are from 4 cruises without barcoding results
db <- left_join(db,haul, by = "cruise_station") %>% dplyr::select(-Ich_Haul_Fctr) %>% filter(is.na(IHF) ==F)

#load in DNA barcoding results
eggs_orig<- read_excel("data/FishEggDatabase_GenID.accdb.xls", sheet = "EggIDData")
#rename eggs columns
eggs<- eggs_orig %>% rename(Sample_ID=`Sample ID`, Common_Name = `Common Name`,Cruise_Name=Cruise) %>%
  mutate(cruise_station = paste(Cruise_Name,Station,sep="_"))
#fix errors in common names
eggs <- eggs %>% mutate(Common_Name = replace(Common_Name,Common_Name == "American","American fourspot flounder")) %>%
  mutate(Common_Name = replace(Common_Name,Common_Name == "Witch Flounder","Witch flounder")) %>%
  mutate(Common_Name = replace(Common_Name,Common_Name == "Yellowtail Flounder","Yellowtail flounder"))

#Load station CTD data
ecomon <- read.csv("data/station_CTD.csv")
#rename columns, select for stations of interest, filter for columns of interest
sst <- ecomon %>% rename(Cruise_Name = CRUISE_NAME, Station = STATION, SST = OCTEMPS_SFC_TEMP) %>% 
  mutate(cruise_station = paste(Cruise_Name,Station,sep="_")) %>% 
  filter(cruise_station %in% eggs$cruise_station | cruise_station %in% db$cruise_station) %>%
  dplyr::select(cruise_station,SST)

#average SST for stations with more than 1
sst <- sst %>% group_by(cruise_station) %>% mutate(SST = mean(SST)) %>% distinct()

#join datasets, select for relevant columns, remove NAs
db_trim<- left_join(db,sst,by="cruise_station") %>% 
  dplyr::select(cruise_station,SST,Egg_Count,IHF,Cruise_Name,Station,Latitude,Longitude) %>% filter(is.na(SST) == F)

#join egg data with temperature data
egg_temp<-left_join(eggs,sst, by = "cruise_station") 

#Dealing with biased subsampling
#see Lewis et al., 2016 for details
#What is tally of eggs barcoded per station, compared with egg count?
station_tally<-eggs %>% group_by(cruise_station) %>% tally()
station_tally <- left_join(station_tally,db_trim,by = "cruise_station") %>%
  rename(barcoded_count = n) %>% mutate(barcoded_count = ifelse(is.na(barcoded_count),0,barcoded_count)) %>% 
  mutate(diff=Egg_Count-barcoded_count) %>% dplyr::select(-SST)
station_tally <- left_join(station_tally, sst, by="cruise_station") %>% filter(is.na(SST) == F)

#pull out eggs from stations that were subsampled
subsampled<-station_tally %>% filter(diff>0)
eggs_sub <-egg_temp %>% 
  filter(cruise_station %in% subsampled$cruise_station)

#pull in information about diameter-based subsampling
#add number of unid'd eggs + id'd per size bin to get total - can then calculate proportionality
sizes <- dplyr::bind_rows(rio::import_list("data/FishEgg_MsmtData.xlsx",setclass = "tbl"),.id = "sheet")
sizes <- sizes %>% rename(cruise_station = sheet) %>% mutate(Tot_Frequency = UnID_Frequency + ID_Frequency) %>%
  dplyr::select(-c(UnID_Frequency,ID_Frequency))

#separate which eggs we have size info for, which not
eggs_sub_size <- eggs_sub %>% filter(cruise_station %in% sizes$cruise_station)
eggs_sub_no_size <- eggs_sub %>% filter(!cruise_station %in% sizes$cruise_station)

#estimate total number of eggs per species per subsampled station
eggs_sub_final<-c()
for (i in 1:length(unique(sizes$cruise_station))){
  cs<-unique(sizes$cruise_station)[i] #pull out unique station
  #get barcorded eggs from that station
  #bin species IDs into size categories
  eggs_to_bin <- eggs_sub_size %>% filter(cruise_station == cs) %>% mutate(diameter = as.numeric(`Egg Diameter (mm)`)) %>% 
    mutate(Bin = ceiling(diameter*20)/20) %>% group_by(Common_Name,Bin,cruise_station) %>% tally()
  #get size bin info from that station
  sizes_bin <- sizes %>% filter(cruise_station == cs)
  #join
  bin_est <- right_join(eggs_to_bin,sizes_bin,by=c("cruise_station","Bin"))
  bin_est <- bin_est %>% group_by(Bin) %>% mutate(tot_barcoded = sum(n)) %>% ungroup()
  #deal with nas, have to join with closest bin with barcoding results
  bin_bad<- bin_est %>% filter(Tot_Frequency >0 & is.na(tot_barcoded)==T)
  if (length(bin_bad$Bin) >0){
    for (j in 1:length(bin_bad$Bin)){
    bin_good<-bin_est %>% filter(is.na(tot_barcoded)==F)
    bin_est <- bin_good %>% 
      mutate(Tot_Frequency= ifelse(Bin == bin_good$Bin[which.min(abs(bin_good$Bin-bin_bad$Bin[j]))],
                                   bin_bad$Tot_Frequency[j]+Tot_Frequency,Tot_Frequency))
    }
  }
  bin_est <- bin_est %>% mutate(est = n*Tot_Frequency/tot_barcoded)
  eggs_sub_size_est <- bin_est %>% group_by(Common_Name,cruise_station) %>% mutate(tot=sum(est)) %>% 
    dplyr::select(Common_Name,cruise_station,tot) %>% distinct()
  eggs_sub_final <- rbind(eggs_sub_final,eggs_sub_size_est)
}

# 11 stations without size info - we assume proportionality
eggs_sub_no_size <- eggs_sub_no_size %>% group_by(cruise_station,Common_Name) %>% tally() %>% rename(abd = n)
eggs_sub_no_size <- left_join(eggs_sub_no_size,subsampled,by="cruise_station") %>% 
  mutate(tot = abd/barcoded_count * Egg_Count) %>% 
  dplyr::select(Common_Name,cruise_station,tot)

eggs_no_sub <- egg_temp %>% filter(!cruise_station %in% subsampled$cruise_station) %>% group_by(Common_Name,cruise_station) %>% 
  tally() %>% rename(tot = n)

#put it all together
#remove NAs, replace 0's with 1's
egg_estimates <- bind_rows(eggs_no_sub,eggs_sub_final,eggs_sub_no_size) %>% filter(is.na(Common_Name)==F) %>%
  mutate(tot=ifelse(tot==0,1,tot))

#add in SST, haul factor info
egg_estimates <- left_join(egg_estimates,sst,by='cruise_station') %>% filter(is.na(SST)==F)
egg_estimates <- left_join(egg_estimates,haul,by="cruise_station") %>% filter(is.na(IHF)==F)

#multiply count by haul factor to get estimates normalized for effort
egg_estimates <- egg_estimates %>% mutate(est=tot*IHF)

#bin temperature into 0.5degC bins
db_trim <- db_trim %>% mutate(temp_bin = round(SST*2)/2)
#tally, calculate proportion
temp_dist_lewis <- db_trim %>% group_by(temp_bin) %>% tally %>% filter(is.na(temp_bin) == F) %>% 
  mutate(total=sum(n),prop_samples=n/total) %>% dplyr::select(temp_bin,prop_samples)

#clear environment
rm(list = setdiff(ls(),c("egg_estimates","temp_dist_lewis","db_trim","ecomon_long","temp_dist_ecomon","theme_Publication","my_pal")))

```



##1.3 Load and prep embryo data from NYOS sampling

These are additional sample collections and DNA barcoding analyses we did in order to supplement EcoMon data
Full dataset is described in Hadjiargyrou et al (in prep)

```{r}
#read in data
fish<-read.csv(here("data/Barcoding_Results_Full.csv"))
stations<-read.csv(here("data/Station_Info.csv"))

#convert Cruise_ID, Station_IN to factor
stations$Cruise_ID<-as.factor(stations$Cruise_ID)
fish$Cruise.ID<-as.factor(fish$Cruise.ID)
stations$Station_ID<-as.factor(stations$Station_ID)
fish$Station.ID<-as.factor(fish$Station.ID)

#use CTD SST data
stations <- stations %>% rename(SST = SST_CTD) %>% mutate(SST = as.numeric(SST)) %>%
  drop_na(SST)
  
#filter just SST data
stations_filter <- stations %>% dplyr::select(Cruise_ID,Station_ID,SST) %>% 
  mutate(cruise_station = paste(Cruise_ID,Station_ID,sep = "_")) %>%
  select(cruise_station,SST)

#remove all columns but genus, species, common name, station, type
fish_filter<- fish %>% 
  dplyr::select(c("Genus.species","Common_Name","Cruise.ID","Station.ID","Stage")) %>% 
  rename("Cruise_ID" = "Cruise.ID") %>% rename("Station_ID"="Station.ID")
  
#filter out 2103, juveniles
fish_filter<-fish_filter %>% filter(Cruise_ID != "2103") %>% filter(Stage!="Juvenile")

#tally all
fish_tally <- fish_filter %>% group_by(Common_Name,Stage) %>% tally()

#SST distribution
temp_dist_NYOS <- stations_filter %>% mutate(temp_bin = round(SST*2)/2)

bins<- temp_dist_NYOS %>% dplyr::select(temp_bin) %>% filter(!is.na(temp_bin)) %>% unique()

#tally, calculate proportion
temp_dist_NYOS <- temp_dist_NYOS %>% group_by(temp_bin) %>% tally %>% filter(is.na(temp_bin) == F) %>% 
  mutate(total=sum(n),prop_samples=n/total) %>% dplyr::select(temp_bin,prop_samples,n) %>% rename(n_temp = n)

#generate clean dataframe
fish_filter<- fish_filter %>% mutate(cruise_station = paste(Cruise_ID,Station_ID,sep = "_")) %>%
  filter(Stage == "Egg", !Common_Name =="") %>% select(Common_Name,cruise_station) %>% group_by(cruise_station, Common_Name) %>% tally()

#select for spp of interest
fish_filter <- fish_filter %>% filter(Common_Name %in% c("Silver Hake","Gulfstream Flounder","Fourspot Flounder","Butterfish","Windowpane Flounder"))
fish_filter <- left_join(fish_filter,stations_filter,by="cruise_station")

rm(fish,fish_tally,stations,bins)
```

#2 Merge three datasets
```{r}
#rename so it's easier
#tweak dataframes so they match, merge
#need cruise_station, ID, temp, abundance estimate for each
eggs_lewis <- egg_estimates %>% select(Common_Name,cruise_station,SST,est) %>% relocate(Common_Name,.after = SST) %>%
  rename(spp = Common_Name, abd = est) %>% mutate(data="Lewis")

eggs_NYOS <- fish_filter %>% relocate(SST,.after = cruise_station) %>%
  rename(spp = Common_Name,abd=n) %>% mutate(data="NYOS")

larvae_ecomon <- ecomon_long %>% rename(SST = sfc_temp,abd=value) %>% mutate(data="EcoMon")

#rename species of interest so they match
#note that I've already filtered EcoMon larval dataset for spp of interest
larvae_ecomon <- larvae_ecomon %>% mutate(spp = ifelse(spp=="hipobl_10m2","Fourspot Flounder",
                                                       ifelse(spp=="merbil_10m2","Silver Hake",
                                                              ifelse(spp=="citarc_10m2","Gulfstream Flounder",
                                                                     ifelse(spp=="scoaqu_10m2","Windowpane Flounder",
                                                                     ifelse(spp=="pep_tri","Butterfish",spp))))))

eggs_lewis <- eggs_lewis %>% mutate(spp = ifelse(spp=="American fourspot flounder","Fourspot Flounder",
                                                 ifelse(spp=="Silver hake","Silver Hake",
                                                        ifelse(spp=="Gulf Stream flounder","Gulfstream Flounder",
                                                               ifelse(spp=="Windowpane", "Windowpane Flounder",
                                                               ifelse(spp=="Atlantic butterfish","Butterfish",spp))))))


ichthyo_all <- rbind(eggs_lewis,eggs_NYOS,larvae_ecomon)
ichthyo_all <- ichthyo_all %>% mutate(temp_bin=round(SST*2)/2)

#merge temperature proportion data into one dataframe
temp_dist_lewis <- temp_dist_lewis %>% select(temp_bin,prop_samples) %>% mutate(data="Lewis")
temp_dist_NYOS <- temp_dist_NYOS %>% select(temp_bin,prop_samples) %>% mutate(data="NYOS")
temp_dist_ecomon <- temp_dist_ecomon %>% select(temp_bin,prop_samples) %>% mutate(data="EcoMon")

temp_dist_all <- rbind(temp_dist_lewis,temp_dist_NYOS,temp_dist_ecomon)
```

#3 Single parameter quotient (SPQ) analysis
```{r}
#select 4 species of interest
spp_interest<-c("Silver Hake","Fourspot Flounder","Gulfstream Flounder", "Butterfish","Windowpane Flounder")
datasets <- c("Lewis","NYOS","EcoMon")

ichthyo_spp <- ichthyo_all %>% filter(spp %in% spp_interest)

#calculate spq, normalized q, cdf of normalized q for each species x dataset combo
cdfs<-c()
for(j in 1: length(datasets)){
  temp_dist <- temp_dist_all %>% filter(data == datasets[j])
  ichthyo <- ichthyo_spp %>% filter(data == datasets[j])
  for(i in 1:length(spp_interest)){
    fish <- ichthyo %>% filter(spp == spp_interest[i])
    #round temp to nearest 0.5deg bin
    fish <- fish %>% mutate(temp_bin = round(SST*2)/2)
    fish_dist <- fish %>% mutate(total = sum(abd,na.rm=T)) %>% 
      group_by(temp_bin) %>% filter(is.na(temp_bin) == F) %>% 
      mutate(prop_fish=sum(abd)/total) %>% dplyr::select(temp_bin,prop_fish) %>% distinct()
    fish_spq<-left_join(temp_dist,fish_dist,by="temp_bin") %>% 
      mutate(prop_fish=ifelse(is.na(prop_fish),0,prop_fish)) %>%
      mutate(q = prop_fish/prop_samples) %>%
      mutate(q_norm = q/sum(q)) %>%
      mutate(cdf_q_norm = cumsum(q_norm)) %>%
      mutate(spp = spp_interest[i],data = datasets[j])
    cdfs <- rbind(cdfs,fish_spq)
  }
}
```
#4 Bootstrapping
```{r}
#need stations with true 0s for bootstrapping
stations_NYOS <- stations_filter %>% select(cruise_station,SST) %>% mutate(data="NYOS")
stations_lewis <- db_trim %>% select(cruise_station,SST) %>% mutate(data="Lewis")
stations_ecomon <- ecomon_long %>% select(cruise_station,sfc_temp) %>% unique() %>% 
 group_by(cruise_station) %>% summarise(SST= mean(sfc_temp)) %>% mutate(data="EcoMon")

stations_all <- rbind(stations_NYOS,stations_lewis,stations_ecomon)

#bootstrapping runs -- this take a long time
# set.seed(19)
# boot<-1000
# boot_out<-c()
# for (s in 1:length(datasets)){
#   stations_boot <- stations_all %>% filter(data == datasets[s])
#   ichthyo_boot <- ichthyo_spp %>% filter(data == datasets[s])
#   for (k in 1:length(spp_interest)) {
#     spp_boot <- ichthyo_boot %>% filter(spp == spp_interest[k]) %>% ungroup %>% select(cruise_station,abd)
#     boot_data <- left_join(stations_boot,spp_boot,by="cruise_station") %>%
#       mutate(abd = replace(abd,is.na(abd),0)) %>% select(-data)
#     for (j in 1:boot){
#       station_n <- nrow(boot_data)
#       newdata<-as.data.frame(matrix(nrow = station_n,ncol=ncol(boot_data)))
#       for(i in 1:station_n){
#         rownums<-sample(1:station_n,length(station_n),replace = T)
#         newdata[i,]<-boot_data[rownums,]
#       }
#       colnames(newdata)<-c("cruise_station","SST","abd")
#       newdata <- newdata %>% mutate(temp_bin = round(SST*2)/2)
#       newdata_temp <- newdata %>% group_by(temp_bin) %>% tally() %>% rename(n_samples = n)
#       newdata <- newdata %>% group_by(temp_bin) %>% mutate(n_fish = sum(abd)) %>%
#         dplyr::select(temp_bin,n_fish) %>% unique()
#       newdata<-left_join(newdata,newdata_temp,by="temp_bin")
#       new_q <- newdata %>% ungroup() %>% mutate(q = (n_fish/sum(n_fish)/(n_samples/sum(n_samples)))) %>%
#         dplyr::select(temp_bin,q) %>% mutate(data=datasets[s],spp=spp_interest[k])
#       boot_out<-rbind(boot_out,new_q)
#     }
#   }
# }
# 
# #save
# write.csv(boot_out,"boot_1000x.csv")

#read in bootstrapping results 
boot_out <- read_csv(here("data/bootstrapping/boot_1000x.csv"))
#I ran bootstrapping for windowpane later on so that is a separate file
window_out <- read_csv(here("data/bootstrapping/boot_windowpane_1000x.csv"))
boot_out <- boot_out[,-1]
window_out <- window_out[,-1]

boot_out <- rbind(boot_out,window_out)

#get 5,95 CI
boot_summary <- boot_out %>% group_by(temp_bin,spp,data) %>% 
  summarise(lower_CI = quantile(q,0.05,na.rm=T),upper_CI = quantile(q,0.95,na.rm=T)) 
```
#5 Map Figures

##5.1 Figure 1: EcoMon Map
```{r}
#set color palette
map_pal <- paletteer_d("nbapalettes::warriors_city2")

stations_lewis <- db_trim %>% select(cruise_station,SST) %>% mutate(data="Lewis")
#load in countries for plotting 
world <- ne_countries(scale = "medium", returnclass = "sf")

#read in raw EcoMon data again
ecomon <- read.csv(here("data/EcoMon_Data/EcoMon_Plankton_Data_v3_8.csv"))

#convert data and create year, month, day columns: 
ecomon$date <- as.Date(ecomon$date, format =  "%d-%b-%y") #b here is the code for month when its words 
ecomon$month <- month(ecomon$date)
ecomon$year <- year(ecomon$date)
ecomon$day <- day(ecomon$date)

ecomon$ID_points <- as.character(rownames(ecomon))

#make EcoMon data spatial with the same defined coordinate system
ecomon_sp <- st_as_sf(x = ecomon, 
                      coords = c("lon", "lat"),
                      crs = 4326)

ecomon_sp <- ecomon_sp %>% mutate(Season = ifelse(month %in% c(12,1,2),"Winter",
                                                ifelse(month %in% c(3,4,5), "Spring",
                                                       ifelse(month %in% c(6,7,8),"Summer",
                                                              "Fall"))))

ecomon <- ecomon %>% mutate(cruise_station = paste(cruise_name,station,sep = "_"))

lewis_sp <- left_join(stations_lewis,ecomon,by="cruise_station") %>% filter(!is.na(lat))

lewis_sp <- st_as_sf(x = lewis_sp, 
                      coords = c("lon", "lat"),
                      crs = 4326)
lewis_sp <- lewis_sp %>% mutate(Season = ifelse(month %in% c(12,1,2),"Winter",
                                                ifelse(month %in% c(3,4,5), "Spring",
                                                       ifelse(month %in% c(6,7,8),"Summer",
                                                              "Fall"))))
# Call in bathymetric data
bathy <- getNOAA.bathy(-80, -65, 33.5, 46, resolution=1); bathydf <- as.xyz(bathy) 
bathydf$col <- NA
bathydf$col <- ifelse(bathydf$V3 >= -100, ifelse(bathydf$V3 < -15, "b","a"),"c")
bathydf$col <- factor(bathydf$col, levels=c("a",""))
# #Separate land from ocean.
bathy_sea <- bathydf; bathy_sea$V3[bathy_sea$V3 > 1] <- NA

#Plot station data analysed in Lewis et al. (2016)
ecomon_egg_map <- ggplot() + geom_sf(data = world) + 
  geom_raster(data=bathy_sea, aes(x=V1, y=V2),fill="#f1f5f8") +
  geom_sf(data = lewis_sp, size = 0.5,aes(color=Season),show.legend = F) + 
  scale_color_manual(values = c(map_pal[3],map_pal[4],map_pal[2],map_pal[1]))+
  geom_sf(data = world,fill="lightgrey") +
  coord_sf(xlim=c(-78, -65), ylim=c(35,45), expand = F)+
  labs(x=NULL,y=NULL)+
  theme_Publication()+
  theme(axis.text.x=element_blank(),axis.text.y = element_blank(),axis.ticks = element_blank())+
  annotate("text",x=-70,y=36,label = "Stations with Egg Data",size=7)
ecomon_egg_map

#Plot all EcoMon data with Lewis samples as inset
Fig_1 <- ggplot() + geom_sf(data = world) + 
  geom_raster(data=bathy_sea, aes(x=V1, y=V2),fill="#f1f5f8") +
  #   #This creates bathymetric contour lines at: 50, 100, 500, 1000, 2000, and 3000 m depth thresholds
  geom_contour(data=bathy_sea, aes(x= V1, y=V2, z=V3), 
               breaks=c(0,-50,-100,-500,-1000,-2000,-3000), colour="black",linewidth = 0.1) +
  geom_sf(data = ecomon_sp, size = 0.5,aes(color=Season))+
  geom_sf(data = world,fill="lightgrey") +
  coord_sf(xlim=c(-78, -65), ylim=c(34,45), expand = F)+
  labs(x=NULL,y=NULL)+
  scale_color_manual(values = c(map_pal[3],map_pal[4],map_pal[2],map_pal[1]),breaks = c("Spring","Summer","Fall","Winter"))+
  theme_Publication()+
   theme(plot.margin = margin(0, 0, 0, 0, "cm"),
        panel.grid.major = element_blank(),
        legend.position = "bottom",
        legend.title = element_text(face="italic",size=18),
        legend.direction = "horizontal",
        legend.text = element_text(size=12, color="black"),
        axis.text=element_text(size=12, color="black"),
        plot.title = element_text(size=18))+
  guides(color = guide_legend(override.aes = list(size=5)))+
  annotation_custom(ggplotGrob(ecomon_egg_map),xmin=-72, xmax=-65, ymin=34, ymax=39)+
  guides(color = guide_legend(override.aes = list(size=4)))+
  ggtitle("EcoMon Larvae Data")

Fig_1+theme(plot.margin=grid::unit(c(0,0,0,0), "mm"))

#save
ggsave(filename = "Figure1.png", plot=Fig_1, width = 8.5, height=11, units=c("in"))
```
##5.2 Figure 2: NYOS Map
```{r}
# Load in Long Island Coastal Shapefile
coastline <-raster::shapefile(here("data/GSHHS_f_L1_CLIPPED2LONGISLAND.shp"))
coast_sub <- raster::crop(coastline, raster::extent(-74.5, -71.0, 38.25, 41.5)) # crop to study site
coast_sub@data$id <- rownames(coast_sub@data) # make some rownames

#Call in bathymetric data
nybathy <- getNOAA.bathy(-74.5, -71, 38.25, 41.5, resolution=1); bathydf <- as.xyz(nybathy) 
bathydf$col <- NA
bathydf$col <- ifelse(bathydf$V3 >= -100, ifelse(bathydf$V3 < -15, "b","a"),"c")
bathydf$col <- factor(bathydf$col, levels=c("a",""))
#Separate land from ocean.
bathy_sea <- bathydf; bathy_sea$V3[bathy_sea$V3 > 1] <- NA

#Generate basemap
basemap <- ggplot() + 
  #This creates bathymetric raster layer; smooth interpolation
  geom_raster(data=bathy_sea, aes(x=V1, y=V2),fill="#e8f0f8") +
  #   #This creates bathymetric contour lines at: 50, 100, 500, 1000, 2000, and 3000 m depth thresholds
  geom_contour(data=bathy_sea, aes(x= V1, y=V2, z=V3), 
              breaks=c(0,-50,-100,-500,-1000,-2000,-3000), colour="black",linewidth = 0.1) +
  #This creates coastline polygons
  geom_polygon(data=coast_sub, aes(x=long, y=lat, group=group), fill="gray60", color="black") +
  #This normalizes the x- and y-axes so there aren't any funky empty white space between the axis edges and the actual plot
  coord_equal(expand=FALSE, ylim=c(38.25, 41.5), xlim=c(-74.5, -71)) +
  #Label axes
  labs(x=expression(paste("Longitude (",degree,"W)")),
       y=expression(paste("Latitude (",degree,"N)")))+
  theme_minimal() +
  theme(text=element_text(size=10), axis.text=element_text(size=10, color="black"),
        strip.background=element_blank(), strip.text=element_blank(),
        plot.margin = unit(c(0, 0, 0, 0), "cm"),
        legend.margin = margin(t=0, r=0, b=0, l=0, unit ="pt")) +
  #Label bathymetric contours
  geom_text(aes(x=x, y=y, label=text),
            data=data.frame(x=c(rep(-71.23,3),rep(-71.28,2)),
                            y=c(40.925, 40.025, 39.875, 39.75,39.55),
                            text=c("50 m","100 m","500 m","1000 m","2000 m")),
            color=c(rep("black",5)),size=2.5)

#Read in file with all waypoint locations
study_area<-read_csv(here("data/lat.long_new.nyos.stations.v6.csv"))
#filter for NYOS waypoints
study_area<-study_area %>% filter(substr(Waypoint, 1,1) %in% c(1,2,3,4,5,6,7,8,9)) %>%
  rename(Station_ID = Waypoint)

#read in data from stations we sampled
station_data<-read.csv(here("data/Station_Info.csv"))

#remove extraneous entries
station_data <- station_data %>% filter(!Haul_ID %in% c("E01B","E25B"))

#isolate season information into own column
station_data_clean <- station_data %>% 
  select(Cruise_ID,Station_ID) %>%
  mutate(season = substring(Cruise_ID,4)) %>%
  group_by(Station_ID)

#count number of times each station was sampled per season and total
station_data_summary <- station_data_clean %>% 
  group_by(Station_ID,season) %>%
  tally() %>%
  ungroup() %>%
  group_by(Station_ID) %>%
  mutate(total = sum(n))

#format data frame for scatterpie plotting function
station_data_summary<-station_data_summary %>% 
  pivot_wider(names_from = season,values_from = n) %>%
  mutate(across(where(is.numeric),~replace_na(.,0)))

#join with lat/lon info
station_data_summary <- left_join(station_data_summary,study_area, by = "Station_ID") 

#rename seasons
station_data_summary <- station_data_summary %>% distinct() %>%
  rename("Spring"="5","Winter"="2","Summer"="7","Fall"="9")

#plot
Fig_2<- basemap +
   geom_scatterpie(data= station_data_summary, 
                   aes(x=Longitude, y=Latitude, r =0.0125*total),
                   cols=c("Spring","Summer","Fall","Winter"),linewidth=0.1,
                   legend_name = "Season")+
  scale_fill_manual(values = c(map_pal[3],map_pal[4],map_pal[2],map_pal[1]))+
  ggtitle("NYOS Data")+
  theme_Publication()+
  theme(legend.position = "bottom")

ggsave(filename = "Figure2.png", plot=Fig_2, width = 8.5, height=11, units=c("in"))
```

#6 Figure S1: SST histograms
```{r}
Fig_S1b <- stations_all %>% filter(!data == "EcoMon") %>%
  ggplot()+
  geom_histogram(aes(x=SST,fill=data),alpha=0.8,binwidth = 0.5)+
  scale_fill_manual(values = c(my_pal[10],my_pal[4]),labels=c("EcoMon Eggs","NYOS Eggs"))+
  geom_histogram(aes(x=SST,color=data,fill=NULL),alpha=0,binwidth = 0.5,show.legend = F)+
  scale_color_manual(values = c(my_pal[10],my_pal[4]))+
  coord_cartesian(expand=F)+
  theme_Publication()+
  theme(legend.position = "inside",legend.position.inside = c(0.1,0.8))+
  xlim(c(-0.5,29))+
  labs(x = expression(paste("Sea Surface Temperature (",degree,"C)")),y="Station Count")
Fig_S1b

Fig_S1a <- stations_all %>% filter(data == "EcoMon") %>%
  ggplot()+
  geom_histogram(aes(x=SST,fill=data),alpha=0.8,binwidth = 0.5)+
  scale_fill_manual(values = my_pal[1],labels="EcoMon Larvae")+
  geom_histogram(aes(x=SST,color=data,fill=NULL),alpha=0,binwidth = 0.5,show.legend = F)+
  scale_color_manual(values = my_pal[1])+
  coord_cartesian(expand=F)+
  theme_Publication()+
  theme(legend.position = "inside",legend.position.inside = c(0.1,0.875))+
  labs(x = expression(paste("Sea Surface Temperature (",degree,"C)")),y="Station Count")
Fig_S1a

Fig_S1 <- Fig_S1a / Fig_S1b + plot_annotation(tag_levels = "A")
ggsave("Figure_S1.png", Fig_S1, width=11, height=8.5,units=c("in"))

```

#7 Single species plotting and modeling

##7.1 Silver Hake
```{r}
Fig_S2a <- boot_summary %>%
  filter(!data == "EcoMon" & spp == "Silver Hake")%>%
  ggplot(aes(x=temp_bin,colour = data))+
  geom_hline(yintercept = 1,linetype="dashed")+
  geom_errorbar(aes(ymin = lower_CI,ymax =upper_CI),linewidth=1.5,alpha=0.5)+
  geom_point(data = cdfs %>% filter(!data == "EcoMon" & spp == "Silver Hake"),aes(x=temp_bin,y=q,color=data),size=2.25)+
  scale_color_manual(values = c(my_pal[10],my_pal[4]),labels=c("EcoMon","NYOS"))+
  labs(x = expression(paste("Sea Surface Temperature (",degree,"C)")),y="Single Parameter Quotient (SPQ)",
       title="Silver Hake Embryos")+
  theme_Publication()+
  theme(legend.position = "inside",legend.position.inside = c(0.15,0.8))

Fig_S2b <- boot_summary %>%
  filter(data == "EcoMon" & spp == "Silver Hake")%>%
  ggplot(aes(x=temp_bin,colour = data))+
  geom_hline(yintercept = 1,linetype="dashed")+
  geom_errorbar(aes(ymin = lower_CI,ymax =upper_CI),linewidth=1.5,alpha=0.5,show.legend=F)+
  geom_point(data = cdfs %>% filter(data == "EcoMon" & spp == "Silver Hake"),aes(x=temp_bin,y=q,color=data),size=2.25,
             show.legend=F)+
  scale_color_manual(values = c(my_pal[1]))+
  labs(x = expression(paste("Sea Surface Temperature (",degree,"C)")),y="Single Parameter Quotient (SPQ)",title="Silver Hake Larvae")+
  theme_Publication()

Fig_S2_top <- Fig_S2a+Fig_S2b

#modeling larvae
spp_cdf<-cdfs %>% filter(data == "EcoMon" & spp == "Silver Hake")
spp_cdf <- spp_cdf %>% mutate(round_cdf = round(cdf_q_norm,digits = 4))
test_glm<-glm(data=spp_cdf,formula=round_cdf~temp_bin, family = "quasibinomial")
test_predictors<-list(temp_bin=seq(min(temp_dist$temp_bin), max(temp_dist$temp_bin),0.5))
glm_vals <- predict(test_glm, newdata=test_predictors, type = "response", se.fit=T)

# Calculate the upper and lower bounds for the confidence intervals
conf_interval <- qnorm(0.975) * glm_vals$se.fit
glm_vals$lower <- glm_vals$fit - conf_interval
glm_vals$upper <- glm_vals$fit + conf_interval

#prep for plotting
glm_predict <- data.frame(temp = test_predictors[[1]], prop = glm_vals$fit,lower=glm_vals$lower,upper=glm_vals$upper)
glm_predict <- glm_predict %>% mutate(stage="Larvae")

#plot
Fig_S2d <- ggplot(data=glm_predict, aes(x=temp,y=prop))+
  geom_line(linewidth=1)+
  geom_line(data=spp_cdf,aes(x=temp_bin,y=cdf_q_norm),color=my_pal[1],linewidth=1)+
  geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.4) +
  theme_Publication()+
  labs(x = expression(paste("Sea Surface Temperature (",degree,"C)")),y="SPQ Cumulative Fraction",title="Silver Hake Larvae")

#modeling eggs
spp_cdf<-cdfs %>% filter(!data == "EcoMon" & spp == "Silver Hake")
spp_cdf <- spp_cdf %>% mutate(round_cdf = round(cdf_q_norm,digits = 4))
test_glm2<-glm(data=spp_cdf,formula=round_cdf~temp_bin, family = "quasibinomial")
test_predictors<-list(temp_bin=seq(min(spp_cdf$temp_bin), max(spp_cdf$temp_bin),0.5))
glm_vals2 <- predict(test_glm2, newdata=test_predictors, type = "response", se.fit=T)

# Calculate the upper and lower bounds for the confidence intervals
lower <- glm_vals2$fit - qnorm(0.975) * glm_vals2$se.fit
upper <- glm_vals2$fit + qnorm(0.975) * glm_vals2$se.fit

#prep for plotting
glm_predict2 <- data.frame(temp = test_predictors[[1]], prop = glm_vals2$fit,lower=lower,upper=upper)
glm_predict2 <- glm_predict2 %>% mutate(stage="Embryos")


Fig_S2c <- ggplot(data=glm_predict2, aes(x=temp,y=prop))+
  geom_line(linewidth=1)+
  geom_line(data=spp_cdf,aes(x=temp_bin,y=cdf_q_norm,color=data),linewidth=1)+
  scale_color_manual(values = c(my_pal[10],my_pal[4]),labels=c("EcoMon","NYOS"))+
  geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.4) +
  theme_Publication()+
  labs(x = expression(paste("Sea Surface Temperature (",degree,"C)")),y="SPQ Cumulative Fraction",title="Silver Hake Embryos")+
  theme(legend.position = "inside",legend.position.inside = c(0.15,0.8))

#compare both models
glm_out <- rbind(glm_predict,glm_predict2)

#Save model comparison plot for Figure 3
Fig_3a <- ggplot(data=glm_out, aes(x=temp,y=prop,color=stage))+
  geom_line(linewidth=1.5,show.legend = F)+
  geom_ribbon(aes(ymin = lower, ymax = upper,fill=stage), alpha = 0.4, linetype = 0,show.legend = F) +
  theme_Publication()+
  scale_color_manual(values = c(my_pal[8],my_pal[12]))+
  scale_fill_manual(values = c(my_pal[8],my_pal[12]))+
  #theme(legend.position = "inside",legend.position.inside = c(0.15,0.8))+
  labs(x = expression(paste("Sea Surface Temperature (",degree,"C)")),y="SPQ Cumulative Fraction",title="Silver Hake")

Fig_S2_bot <- (Fig_S2c + Fig_S2d)
Fig_S2 <- Fig_S2_top / Fig_S2_bot  + plot_annotation(tag_levels = "A")

ggsave("Figure_S2.png", Fig_S2, width=11, height=8.5,units=c("in"))

```

##7.2 Windowpane Flounder
```{r}
Fig_S3a <- boot_summary %>%
  filter(!data == "EcoMon" & spp == "Windowpane Flounder")%>%
  ggplot(aes(x=temp_bin,colour = data))+
  geom_hline(yintercept = 1,linetype="dashed")+
  geom_errorbar(aes(ymin = lower_CI,ymax =upper_CI),linewidth=1.5,alpha=0.5)+
  geom_point(data = cdfs %>% filter(!data == "EcoMon" & spp == "Windowpane Flounder"),aes(x=temp_bin,y=q,color=data),size=2.25)+
  scale_color_manual(values = c(my_pal[10],my_pal[4]),labels=c("EcoMon","NYOS"))+
  labs(x = expression(paste("Sea Surface Temperature (",degree,"C)")),y="Single Parameter Quotient (SPQ)",
       title="Windowpane Flounder Embryos")+
  theme_Publication()+
  theme(legend.position = "inside",legend.position.inside = c(0.15,0.8))

Fig_S3b <- boot_summary %>%
  filter(data == "EcoMon" & spp == "Windowpane Flounder")%>%
  ggplot(aes(x=temp_bin,colour = data))+
  geom_hline(yintercept = 1,linetype="dashed")+
  geom_errorbar(aes(ymin = lower_CI,ymax =upper_CI),linewidth=1.5,alpha=0.5,show.legend=F)+
  geom_point(data = cdfs %>% filter(data == "EcoMon" & spp == "Windowpane Flounder"),aes(x=temp_bin,y=q,color=data),size=2.25,
             show.legend=F)+
  scale_color_manual(values = c(my_pal[1]))+
  labs(x = expression(paste("Sea Surface Temperature (",degree,"C)")),y="Single Parameter Quotient (SPQ)",title="Windowpane Flounder Larvae")+
  theme_Publication()

Fig_S3_top <- Fig_S3a+Fig_S3b

#modeling larvae
spp_cdf<-cdfs %>% filter(data == "EcoMon" & spp == "Windowpane Flounder")
spp_cdf <- spp_cdf %>% mutate(round_cdf = round(cdf_q_norm,digits = 4))
test_glm<-glm(data=spp_cdf,formula=round_cdf~temp_bin, family = "quasibinomial")
test_predictors<-list(temp_bin=seq(min(temp_dist$temp_bin), max(temp_dist$temp_bin),0.5))
glm_vals <- predict(test_glm, newdata=test_predictors, type = "response", se.fit=T)

# Calculate the upper and lower bounds for the confidence intervals
conf_interval <- qnorm(0.975) * glm_vals$se.fit
glm_vals$lower <- glm_vals$fit - conf_interval
glm_vals$upper <- glm_vals$fit + conf_interval

#prep for plotting
glm_predict <- data.frame(temp = test_predictors[[1]], prop = glm_vals$fit,lower=glm_vals$lower,upper=glm_vals$upper)
glm_predict <- glm_predict %>% mutate(stage="Larvae")

#plot
Fig_S3d <- ggplot(data=glm_predict, aes(x=temp,y=prop))+
  geom_line(linewidth=1)+
  geom_line(data=spp_cdf,aes(x=temp_bin,y=cdf_q_norm),color=my_pal[1],linewidth=1)+
  geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.4) +
  theme_Publication()+
  labs(x = expression(paste("Sea Surface Temperature (",degree,"C)")),y="SPQ Cumulative Fraction",title="Windowpane Flounder Larvae")

#modeling eggs
spp_cdf<-cdfs %>% filter(!data == "EcoMon" & spp == "Windowpane Flounder")
spp_cdf <- spp_cdf %>% mutate(round_cdf = round(cdf_q_norm,digits = 4))
test_glm2<-glm(data=spp_cdf,formula=round_cdf~temp_bin, family = "quasibinomial")
test_predictors<-list(temp_bin=seq(min(spp_cdf$temp_bin), max(spp_cdf$temp_bin),0.5))
glm_vals2 <- predict(test_glm2, newdata=test_predictors, type = "response", se.fit=T)

# Calculate the upper and lower bounds for the confidence intervals
lower <- glm_vals2$fit - qnorm(0.975) * glm_vals2$se.fit
upper <- glm_vals2$fit + qnorm(0.975) * glm_vals2$se.fit

#prep for plotting
glm_predict2 <- data.frame(temp = test_predictors[[1]], prop = glm_vals2$fit,lower=lower,upper=upper)
glm_predict2 <- glm_predict2 %>% mutate(stage="Embryos")


Fig_S3c <- ggplot(data=glm_predict2, aes(x=temp,y=prop))+
  geom_line(linewidth=1)+
  geom_line(data=spp_cdf,aes(x=temp_bin,y=cdf_q_norm,color=data),linewidth=1)+
  scale_color_manual(values = c(my_pal[10],my_pal[4]),labels=c("EcoMon","NYOS"))+
  geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.4) +
  theme_Publication()+
  labs(x = expression(paste("Sea Surface Temperature (",degree,"C)")),y="SPQ Cumulative Fraction",title="Windowpane Flounder Embryos")+
  theme(legend.position = "inside",legend.position.inside = c(0.15,0.8))

#compare both models
glm_out <- rbind(glm_predict,glm_predict2)

#Save model comparison plot for Figure 3
Fig_3b <- ggplot(data=glm_out, aes(x=temp,y=prop,color=stage))+
  geom_line(linewidth=1.5,show.legend = F)+
  geom_ribbon(aes(ymin = lower, ymax = upper,fill=stage), alpha = 0.4, linetype = 0,show.legend = F) +
  theme_Publication()+
  scale_color_manual(values = c(my_pal[8],my_pal[12]))+
  scale_fill_manual(values = c(my_pal[8],my_pal[12]))+
  #theme(legend.position = "inside",legend.position.inside = c(0.15,0.8))+
  labs(x = expression(paste("Sea Surface Temperature (",degree,"C)")),y="SPQ Cumulative Fraction",title="Windowpane Flounder")

Fig_S3_bot <- (Fig_S3c + Fig_S3d)
Fig_S3 <- Fig_S3_top / Fig_S3_bot  + plot_annotation(tag_levels = "A")

ggsave("Figure_S3.png", Fig_S3, width=11, height=8.5,units=c("in"))
```

##7.3 Gulfstream Flounder
```{r}
Fig_S4a <- boot_summary %>%
  filter(!data == "EcoMon" & spp == "Gulfstream Flounder")%>%
  ggplot(aes(x=temp_bin,colour = data))+
  geom_hline(yintercept = 1,linetype="dashed")+
  geom_errorbar(aes(ymin = lower_CI,ymax =upper_CI),linewidth=1.5,alpha=0.5)+
  geom_point(data = cdfs %>% filter(!data == "EcoMon" & spp == "Gulfstream Flounder"),aes(x=temp_bin,y=q,color=data),size=2.25)+
  scale_color_manual(values = c(my_pal[10],my_pal[4]),labels=c("EcoMon","NYOS"))+
  labs(x = expression(paste("Sea Surface Temperature (",degree,"C)")),y="Single Parameter Quotient (SPQ)",
       title="Gulfstream Flounder Embryos")+
  theme_Publication()+
  theme(legend.position = "inside",legend.position.inside = c(0.15,0.8))

Fig_S4b <- boot_summary %>%
  filter(data == "EcoMon" & spp == "Gulfstream Flounder")%>%
  ggplot(aes(x=temp_bin,colour = data))+
  geom_hline(yintercept = 1,linetype="dashed")+
  geom_errorbar(aes(ymin = lower_CI,ymax =upper_CI),linewidth=1.5,alpha=0.5,show.legend=F)+
  geom_point(data = cdfs %>% filter(data == "EcoMon" & spp == "Gulfstream Flounder"),aes(x=temp_bin,y=q,color=data),size=2.25,
             show.legend=F)+
  scale_color_manual(values = c(my_pal[1]))+
  labs(x = expression(paste("Sea Surface Temperature (",degree,"C)")),y="Single Parameter Quotient (SPQ)",title="Gulfstream Flounder Larvae")+
  theme_Publication()

Fig_S4_top <- Fig_S4a+Fig_S4b

#modeling larvae
spp_cdf<-cdfs %>% filter(data == "EcoMon" & spp == "Gulfstream Flounder")
spp_cdf <- spp_cdf %>% mutate(round_cdf = round(cdf_q_norm,digits = 4))
test_glm<-glm(data=spp_cdf,formula=round_cdf~temp_bin, family = "quasibinomial")
test_predictors<-list(temp_bin=seq(-0.5,30,0.5))
glm_vals <- predict(test_glm, newdata=test_predictors, type = "response", se.fit=T)

# Calculate the upper and lower bounds for the confidence intervals
conf_interval <- qnorm(0.975) * glm_vals$se.fit
glm_vals$lower <- glm_vals$fit - conf_interval
glm_vals$upper <- glm_vals$fit + conf_interval

#prep for plotting
glm_predict <- data.frame(temp = test_predictors[[1]], prop = glm_vals$fit,lower=glm_vals$lower,upper=glm_vals$upper)
glm_predict <- glm_predict %>% mutate(stage="Larvae")

#plot
Fig_S4d <- ggplot(data=glm_predict, aes(x=temp,y=prop))+
  geom_line(linewidth=1)+
  geom_line(data=spp_cdf,aes(x=temp_bin,y=cdf_q_norm),color=my_pal[1],linewidth=1)+
  geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.4) +
  theme_Publication()+
  labs(x = expression(paste("Sea Surface Temperature (",degree,"C)")),y="SPQ Cumulative Fraction",title="Gulfstream Flounder Larvae")

#modeling eggs
spp_cdf<-cdfs %>% filter(!data == "EcoMon" & spp == "Gulfstream Flounder")
spp_cdf <- spp_cdf %>% mutate(round_cdf = round(cdf_q_norm,digits = 4))
test_glm2<-glm(data=spp_cdf,formula=round_cdf~temp_bin, family = "quasibinomial")
test_predictors<-list(temp_bin=seq(-0.5,30,0.5))
glm_vals2 <- predict(test_glm2, newdata=test_predictors, type = "response", se.fit=T)

# Calculate the upper and lower bounds for the confidence intervals
lower <- glm_vals2$fit - qnorm(0.975) * glm_vals2$se.fit
upper <- glm_vals2$fit + qnorm(0.975) * glm_vals2$se.fit

#prep for plotting
glm_predict2 <- data.frame(temp = test_predictors[[1]], prop = glm_vals2$fit,lower=lower,upper=upper)
glm_predict2 <- glm_predict2 %>% mutate(stage="Embryos")


Fig_S4c <- ggplot(data=glm_predict2, aes(x=temp,y=prop))+
  geom_line(linewidth=1)+
  geom_line(data=spp_cdf,aes(x=temp_bin,y=cdf_q_norm,color=data),linewidth=1)+
  scale_color_manual(values = c(my_pal[10],my_pal[4]),labels=c("EcoMon","NYOS"))+
  geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.4) +
  theme_Publication()+
  labs(x = expression(paste("Sea Surface Temperature (",degree,"C)")),y="SPQ Cumulative Fraction",title="Gulfstream Flounder Embryos")+
  theme(legend.position = "inside",legend.position.inside = c(0.15,0.8))

#compare both models
glm_out <- rbind(glm_predict,glm_predict2)

#Save model comparison plot for Figure 3
Fig_3c <- ggplot(data=glm_out, aes(x=temp,y=prop,color=stage))+
  geom_line(linewidth=1.5,show.legend = F)+
  geom_ribbon(aes(ymin = lower, ymax = upper,fill=stage), alpha = 0.4, linetype = 0,show.legend = F) +
  theme_Publication()+
  scale_color_manual(values = c(my_pal[8],my_pal[12]))+
  scale_fill_manual(values = c(my_pal[8],my_pal[12]))+
  #theme(legend.position = "inside",legend.position.inside = c(0.15,0.8))+
  labs(x = expression(paste("Sea Surface Temperature (",degree,"C)")),y="SPQ Cumulative Fraction",title="Gulfstream Flounder")

Fig_S4_bot <- (Fig_S4c + Fig_S4d)
Fig_S4 <- Fig_S4_top / Fig_S4_bot  + plot_annotation(tag_levels = "A")

ggsave("Figure_S4.png", Fig_S4, width=11, height=8.5,units=c("in"))
```

##7.4 Fourspot Flounder
```{r}
Fig_S5a <- boot_summary %>%
  filter(!data == "EcoMon" & spp == "Fourspot Flounder")%>%
  ggplot(aes(x=temp_bin,colour = data))+
  geom_hline(yintercept = 1,linetype="dashed")+
  geom_errorbar(aes(ymin = lower_CI,ymax =upper_CI),linewidth=1.5,alpha=0.5)+
  geom_point(data = cdfs %>% filter(!data == "EcoMon" & spp == "Fourspot Flounder"),aes(x=temp_bin,y=q,color=data),size=2.25)+
  scale_color_manual(values = c(my_pal[10],my_pal[4]),labels=c("EcoMon","NYOS"))+
  labs(x = expression(paste("Sea Surface Temperature (",degree,"C)")),y="Single Parameter Quotient (SPQ)",
       title="Fourspot Flounder Embryos")+
  theme_Publication()+
  theme(legend.position = "inside",legend.position.inside = c(0.15,0.8))

Fig_S5b <- boot_summary %>%
  filter(data == "EcoMon" & spp == "Fourspot Flounder")%>%
  ggplot(aes(x=temp_bin,colour = data))+
  geom_hline(yintercept = 1,linetype="dashed")+
  geom_errorbar(aes(ymin = lower_CI,ymax =upper_CI),linewidth=1.5,alpha=0.5,show.legend=F)+
  geom_point(data = cdfs %>% filter(data == "EcoMon" & spp == "Fourspot Flounder"),aes(x=temp_bin,y=q,color=data),size=2.25,
             show.legend=F)+
  scale_color_manual(values = c(my_pal[1]))+
  labs(x = expression(paste("Sea Surface Temperature (",degree,"C)")),y="Single Parameter Quotient (SPQ)",title="Fourspot Flounder Larvae")+
  theme_Publication()

Fig_S5_top <- Fig_S5a+Fig_S5b

#modeling larvae
spp_cdf<-cdfs %>% filter(data == "EcoMon" & spp == "Fourspot Flounder")
spp_cdf <- spp_cdf %>% mutate(round_cdf = round(cdf_q_norm,digits = 4))
test_glm<-glm(data=spp_cdf,formula=round_cdf~temp_bin, family = "quasibinomial")
test_predictors<-list(temp_bin=seq(-0.5,30,0.5))
glm_vals <- predict(test_glm, newdata=test_predictors, type = "response", se.fit=T)

# Calculate the upper and lower bounds for the confidence intervals
conf_interval <- qnorm(0.975) * glm_vals$se.fit
glm_vals$lower <- glm_vals$fit - conf_interval
glm_vals$upper <- glm_vals$fit + conf_interval

#prep for plotting
glm_predict <- data.frame(temp = test_predictors[[1]], prop = glm_vals$fit,lower=glm_vals$lower,upper=glm_vals$upper)
glm_predict <- glm_predict %>% mutate(stage="Larvae")

#plot
Fig_S5d <- ggplot(data=glm_predict, aes(x=temp,y=prop))+
  geom_line(linewidth=1)+
  geom_line(data=spp_cdf,aes(x=temp_bin,y=cdf_q_norm),color=my_pal[1],linewidth=1)+
  geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.4) +
  theme_Publication()+
  labs(x = expression(paste("Sea Surface Temperature (",degree,"C)")),y="SPQ Cumulative Fraction",title="Fourspot Flounder Larvae")

#modeling eggs
spp_cdf<-cdfs %>% filter(!data == "EcoMon" & spp == "Fourspot Flounder")
spp_cdf <- spp_cdf %>% mutate(round_cdf = round(cdf_q_norm,digits = 4))
test_glm2<-glm(data=spp_cdf,formula=round_cdf~temp_bin, family = "quasibinomial")
test_predictors<-list(temp_bin=seq(-0.5,30,0.5))
glm_vals2 <- predict(test_glm2, newdata=test_predictors, type = "response", se.fit=T)

# Calculate the upper and lower bounds for the confidence intervals
lower <- glm_vals2$fit - qnorm(0.975) * glm_vals2$se.fit
upper <- glm_vals2$fit + qnorm(0.975) * glm_vals2$se.fit

#prep for plotting
glm_predict2 <- data.frame(temp = test_predictors[[1]], prop = glm_vals2$fit,lower=lower,upper=upper)
glm_predict2 <- glm_predict2 %>% mutate(stage="Embryos")


Fig_S5c <- ggplot(data=glm_predict2, aes(x=temp,y=prop))+
  geom_line(linewidth=1)+
  geom_line(data=spp_cdf,aes(x=temp_bin,y=cdf_q_norm,color=data),linewidth=1)+
  scale_color_manual(values = c(my_pal[10],my_pal[4]),labels=c("EcoMon","NYOS"))+
  geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.4) +
  theme_Publication()+
  labs(x = expression(paste("Sea Surface Temperature (",degree,"C)")),y="SPQ Cumulative Fraction",title="Fourspot Flounder Embryos")+
  theme(legend.position = "inside",legend.position.inside = c(0.15,0.8))

#compare both models
glm_out <- rbind(glm_predict,glm_predict2)

#Save model comparison plot for Figure 3
Fig_3d <- ggplot(data=glm_out, aes(x=temp,y=prop,color=stage))+
  geom_line(linewidth=1.5,show.legend = F)+
  geom_ribbon(aes(ymin = lower, ymax = upper,fill=stage), alpha = 0.4, linetype = 0,show.legend = F) +
  theme_Publication()+
  scale_color_manual(values = c(my_pal[8],my_pal[12]))+
  scale_fill_manual(values = c(my_pal[8],my_pal[12]))+
  #theme(legend.position = "inside",legend.position.inside = c(0.15,0.8))+
  labs(x = expression(paste("Sea Surface Temperature (",degree,"C)")),y="SPQ Cumulative Fraction",title="Fourspot Flounder")

Fig_S5_bot <- (Fig_S5c + Fig_S5d)
Fig_S5 <- Fig_S5_top / Fig_S5_bot  + plot_annotation(tag_levels = "A")

ggsave("Figure_S5.png", Fig_S5, width=11, height=8.5,units=c("in"))
```

##7.5 Butterfish
```{r}
Fig_S6a <- boot_summary %>%
  filter(!data == "EcoMon" & spp == "Butterfish")%>%
  ggplot(aes(x=temp_bin,colour = data))+
  geom_hline(yintercept = 1,linetype="dashed")+
  geom_errorbar(aes(ymin = lower_CI,ymax =upper_CI),linewidth=1.5,alpha=0.5)+
  geom_point(data = cdfs %>% filter(!data == "EcoMon" & spp == "Butterfish"),aes(x=temp_bin,y=q,color=data),size=2.25)+
  scale_color_manual(values = c(my_pal[10],my_pal[4]),labels=c("EcoMon","NYOS"))+
  labs(x = expression(paste("Sea Surface Temperature (",degree,"C)")),y="Single Parameter Quotient (SPQ)",
       title="Butterfish Embryos")+
  theme_Publication()+
  theme(legend.position = "inside",legend.position.inside = c(0.15,0.8))

Fig_S6b <- boot_summary %>%
  filter(data == "EcoMon" & spp == "Butterfish")%>%
  ggplot(aes(x=temp_bin,colour = data))+
  geom_hline(yintercept = 1,linetype="dashed")+
  geom_errorbar(aes(ymin = lower_CI,ymax =upper_CI),linewidth=1.5,alpha=0.5,show.legend=F)+
  geom_point(data = cdfs %>% filter(data == "EcoMon" & spp == "Butterfish"),aes(x=temp_bin,y=q,color=data),size=2.25,
             show.legend=F)+
  scale_color_manual(values = c(my_pal[1]))+
  labs(x = expression(paste("Sea Surface Temperature (",degree,"C)")),y="Single Parameter Quotient (SPQ)",title="Butterfish Larvae")+
  theme_Publication()

Fig_S6_top <- Fig_S6a+Fig_S6b

#modeling larvae
spp_cdf<-cdfs %>% filter(data == "EcoMon" & spp == "Butterfish")
spp_cdf <- spp_cdf %>% mutate(round_cdf = round(cdf_q_norm,digits = 4))
test_glm<-glm(data=spp_cdf,formula=round_cdf~temp_bin, family = "quasibinomial")
test_predictors<-list(temp_bin=seq(-0.5,30,0.5))
glm_vals <- predict(test_glm, newdata=test_predictors, type = "response", se.fit=T)

# Calculate the upper and lower bounds for the confidence intervals
conf_interval <- qnorm(0.975) * glm_vals$se.fit
glm_vals$lower <- glm_vals$fit - conf_interval
glm_vals$upper <- glm_vals$fit + conf_interval

#prep for plotting
glm_predict <- data.frame(temp = test_predictors[[1]], prop = glm_vals$fit,lower=glm_vals$lower,upper=glm_vals$upper)
glm_predict <- glm_predict %>% mutate(stage="Larvae")

#plot
Fig_S6d <- ggplot(data=glm_predict, aes(x=temp,y=prop))+
  geom_line(linewidth=1)+
  geom_line(data=spp_cdf,aes(x=temp_bin,y=cdf_q_norm),color=my_pal[1],linewidth=1)+
  geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.4) +
  theme_Publication()+
  labs(x = expression(paste("Sea Surface Temperature (",degree,"C)")),y="SPQ Cumulative Fraction",title="Butterfish Larvae")

#modeling eggs
spp_cdf<-cdfs %>% filter(!data == "EcoMon" & spp == "Butterfish")
spp_cdf <- spp_cdf %>% mutate(round_cdf = round(cdf_q_norm,digits = 4))
test_glm2<-glm(data=spp_cdf,formula=round_cdf~temp_bin, family = "quasibinomial")
test_predictors<-list(temp_bin=seq(-0.5,30,0.5))
glm_vals2 <- predict(test_glm2, newdata=test_predictors, type = "response", se.fit=T)

# Calculate the upper and lower bounds for the confidence intervals
lower <- glm_vals2$fit - qnorm(0.975) * glm_vals2$se.fit
upper <- glm_vals2$fit + qnorm(0.975) * glm_vals2$se.fit

#prep for plotting
glm_predict2 <- data.frame(temp = test_predictors[[1]], prop = glm_vals2$fit,lower=lower,upper=upper)
glm_predict2 <- glm_predict2 %>% mutate(stage="Embryos")


Fig_S6c <- ggplot(data=glm_predict2, aes(x=temp,y=prop))+
  geom_line(linewidth=1)+
  geom_line(data=spp_cdf,aes(x=temp_bin,y=cdf_q_norm,color=data),linewidth=1)+
  scale_color_manual(values = c(my_pal[10],my_pal[4]),labels=c("EcoMon","NYOS"))+
  geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.4) +
  theme_Publication()+
  labs(x = expression(paste("Sea Surface Temperature (",degree,"C)")),y="SPQ Cumulative Fraction",title="Butterfish Embryos")+
  theme(legend.position = "inside",legend.position.inside = c(0.15,0.8))

#compare both models
glm_out <- rbind(glm_predict,glm_predict2)

#Save model comparison plot for Figure 3
Fig_3e <- ggplot(data=glm_out, aes(x=temp,y=prop,color=stage))+
  geom_line(linewidth=1.5,show.legend = F)+
  geom_ribbon(aes(ymin = lower, ymax = upper,fill=stage), alpha = 0.4, linetype = 0,show.legend = F) +
  theme_Publication()+
  scale_color_manual(values = c(my_pal[8],my_pal[12]))+
  scale_fill_manual(values = c(my_pal[8],my_pal[12]))+
  #theme(legend.position = "inside",legend.position.inside = c(0.15,0.8))+
  labs(x = expression(paste("Sea Surface Temperature (",degree,"C)")),y="SPQ Cumulative Fraction",title="Butterfish")

Fig_S6_bot <- (Fig_S6c + Fig_S6d)
Fig_S6 <- Fig_S6_top / Fig_S6_bot  + plot_annotation(tag_levels = "A")

ggsave("Figure_S6.png", Fig_S6, width=11, height=8.5,units=c("in"))
```

## Figure 3: Model comparisons, all species
```{r}
Fig_3 <- Fig_3a+Fig_3b+Fig_3c+Fig_3d+Fig_3e +plot_layout(guides = "collect")+ plot_annotation(tag_levels = "A")
design <- "
1122
3344
#55#
"
Fig_3 <- Fig_3 + plot_layout(design=design) & 
  theme(legend.position = "bottom",legend.text=element_text(size=14)) 
Fig_3

ggsave("Figure_3.png", Fig_3, width=11, height=10,units=c("in"))
```

